# Redis持久化

# 持久化的概述

我们知道Redis是一个内存数据库，当Redis宕机或者断电的时候，就会丢失数据，因此Redis就提供了持久化机制来确保数据不会丢失。Redis有两种持久化的方式，分别是：RDB和AOF。下面，我们就来学习这两种持久化的方式。

# RDB持久化

## 概述

Redis的RDB就是在某一个时刻执行内存快照，将这一时刻的Redis数据库状态生成一个rdb文件，然后存放在磁盘中。当Redis进程重启的时候，直接读取这个文件就可以恢复数据了。

## 原理

有两种方式可以生产RDB文件，分别是SAVE和BGSAVE命令。

当执行SAVE命令的时候，主进程会生成一个RDB文件，这是一个阻塞的操作，直到RDB文件创建完毕，主进程才可以继续处理客户端的命令请求。

而执行BGSAVE的时候，主进程会fork一个子进程，让子进程去执行SAVE操作，这样主进程就不会被阻塞，因此主进程可以继续处理请求。

## 优缺点

- 优点
    - RDB性能比较高，因为可以让子进程去生产RDB文件的，不会影响主进程处理请求，因此性能是比较高的。
    - 恢复数据快，当Redis进程重启的时候，直接读取RDB文件就可以恢复数据，所以RDB恢复数据的速度是比较快的。
- 缺点
    - 容易丢失数据，当Redis宕机或者断电的时候，Redis就会丢失上一次生成RDB到宕机这个时间段的数据，生成RDB文件的间隔越长，丢失就越多。

## 思考点

- 生产RDB文件的频率越短越好吗？
    - 虽然RDB文件时可以使用子进程去生成，但是当频繁执行BASAVE命令时，主进程就要频繁地执行fork函数去生成子进程，fork时会阻塞主进程的，所以频繁地生成RDB文件对性能的影响时很大的。
- 生产RDB文件时，命令对同一个key修改了怎么办？
    - 因此fork操作是采用的是写时复制的方法，主进程要对一个kek进行修改，会复制一个空间，然后在这个空间进行操作，所以主进程的写操作和子进程的读操作是没有影响的。

# AOF持久化

## 概述

Redis的AOF就是执行完写命令之后会将命令追加到AOF文件中，当Redis进程重启的时候执行AOF文件的命令来恢复数据。

## 原理

我们在配置文件中配置AOF的开关，就可以开启Redis的AOF的持久化功能。当AOF的开关打开之后，当服务器执行完一个写命令的时候，会将这个写命令放到aof_buf缓存区中，然后等一个合适的时机将缓冲区的数据刷到磁盘中。

而什么刷回磁盘中，是可以通过设置的：

- 如果选择的是always的话，表示每执行一个命令就立刻刷磁盘，这种方式是最安全的，断电了最多也只会丢失一条数据，但是性能是最差的。
- 如果选择的是no，表示让操作系统自己决定什么时候刷盘，这种方式可能会丢失比较多的数据，但是性能是比较好的。
- 如果选择的是everysec，表示每隔一秒钟就会执行一次刷盘操作，这种方式就兼顾了数据的安全和性能，是AOF默认的刷盘频率。

## 优缺点

- 优点
    - 数据比较安全，丢失的数据会比较少
- 缺点
    - 当Redis重启的时候，需要执行AOF文件的命令来恢复数据，恢复数据的速度会比较慢

## AOF重写

随着Redis服务的执行，AOF文件会越来越大，这样无论是对文件的写入还是Redis恢复时执行AOF文件的命令，都是很影响到性能的。因此，Redis会对AOF文件进行重写。

如果我们对一个key进行5次的修改操作，没有重写前，这个key在AOF文件中就会有五条记录。进行重写之后，AOF文件只会存放这个key最后一次的值，只有一条命令，这样就可以避免AOF文件过大而造成的性能问题。

# 怎么使用持久化

一般都是混合使用RDB和AOF，就是每隔一段时间执行一次Redis快照，然后在这一个间隔的期间使用AOF文件记录写命令，这样既可以确保数据尽量少丢失，也可以确保Redis的性能问题。




